#!/bin/bash

# Colores
G='\033[0;32m'
B='\033[0;34m'
Y='\033[1;33m'
R='\033[0;31m'
NC='\033[0m'

# Función Spinner
spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    while kill -0 "$pid" 2>/dev/null; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

# Funciones de Limpieza
clean_packages() {
    echo -e "${Y}Iniciando limpieza de paquetes...${NC}"
    if ping -c 1 8.8.8.8 &>/dev/null; then
        printf "Actualizando repositorios..."
        sudo apt update -y &>/dev/null & spinner $!
        echo -e "${G} OK${NC}"
    fi
    printf "Eliminando paquetes innecesarios y caché..."
    (sudo apt autoremove -y && sudo apt autoclean) &>/dev/null & spinner $!
    echo -e "\n.. .. ... ..... .... ..... .... .."
    echo -e "${G} ✓ Limpieza de paquetes completada${NC}"
    echo ".. .. .... ... .. ... ... .... . ."
}

clean_logs() {
    echo -e "${Y}Reduciendo logs del sistema (2 días)...${NC}"
    sudo journalctl --vacuum-time=2d &>/dev/null & spinner $!
    echo -e "... ... . ...... ... ... .. ."
    echo -e "${G} ✓ Logs optimizados${NC}"
    echo "... ... ... .... ... ... .. ."
}

show_help() {
    echo -e "${B}Uso: fclean [opciones]${NC}"
    echo -e ""
    echo -e "Opciones disponibles:"
    echo -e "  ${G}-p${NC}   Limpiar paquetes (update, autoremove, autoclean)"
    echo -e "  ${G}-l${NC}   Limpiar logs (journalctl vacuum)"
    echo -e "  ${G}-h${NC}   Mostrar esta ayuda"
    echo -e ""
    echo -e "Ejemplo: ${Y}fclean -p${NC}"
}

# Lógica de flags (getopts)
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

while getopts "plh" opt; do
    case ${opt} in
        p ) clean_packages ;;
        l ) clean_logs ;;
        h ) show_help ;;
        \? ) show_help ;;
    esac
done
